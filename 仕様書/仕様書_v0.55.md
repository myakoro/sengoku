# 戦国立身出世SLG v0.55 仕様書

**作成者**: Antigravity（仕様書作成専任エンジニア）  
**対象**: 実装担当エンジニア  
**参照資料**:
- 戦国立身出世SLG v0.5 要件定義書.txt（完全更新版）
- 別紙C：役職システム_修正版_v0.5準拠.txt
- 別紙E：家臣団システ_修正版_v0.5.txt
- 別紙I：出世・役職構_修正版_v0.5.txt
- 別紙J：忠誠・能力開示・貸し借_修正版_v0.5準拠.txt
- 別紙M：時間進行・行動管_修正版_v0.5準拠.txt

---

## 目次

1. [データモデル仕様](#1-データモデル仕様)
2. [家臣団ロジック（役職系）](#2-家臣団ロジック役職系)
3. [戦闘ロジック（護衛小隊 / 個人戦闘能力）](#3-戦闘ロジック護衛小隊--個人戦闘能力)
4. [補佐官ロジック（政務・知略専用）](#4-補佐官ロジック政務知略専用)
5. [出世ロジック（主人公・家臣）](#5-出世ロジック主人公家臣)
6. [忠誠・能力開示ロジック](#6-忠誠能力開示ロジック)
7. [月次処理ロジック](#7-月次処理ロジック)
8. [画面I/O（UIとロジック間データ入出力）](#8-画面iouitロジック間データ入出力)
9. [バリデーション / 例外処理](#9-バリデーション--例外処理)

---

## 1. データモデル仕様

### 1.1 能力体系（4能力）

本作の人物（主人公・家臣）はすべて以下の4能力を持つ。

| 能力名 | 英語名 | 説明 | 主な影響範囲 |
|--------|--------|------|------------|
| **個人戦闘能力** | `AbilityCombat` | 純粋な武芸の強さ。一騎打ちや個人戦闘での力量 | 従僕・徒士の戦闘、護衛小隊戦力 |
| **統率** | `AbilityLeadership` | 部隊を動かす能力。隊の行動最適化・死亡率変動 | 組頭・部将の指揮、戦場AI（v0.6以降） |
| **政務** | `AbilityPolitics` | 公務処理能力。字書き・行政事務 | 公務成功率、補佐官補正対象 |
| **知略** | `AbilityIntrigue` | 判断力・戦場の流れ読み | 公務判断、補佐官補正対象 |

**重要な設計原則**:
- **個人戦闘能力と統率は完全に分離**
- 従僕・徒士は「個人戦闘能力」が主軸
- 組頭・部将は「統率」が主軸
- 補佐官補正は「政務・知略」のみ対象（個人戦闘能力・統率は対象外）

---

### 1.2 主人公データ構造

| フィールド名 | 型 | 説明 | 初期値（v0.5） |
|------------|---|------|--------------|
| `Id` | string | 主人公ID | 自動生成 |
| `Name` | string | 名前 | ユーザー入力 |
| `Age` | int | 年齢 | ユーザー入力 |
| `Rank` | enum `Rank` | 役職（徒士/組頭/部将） | `Rank.Toshi`（徒士） |
| `HouseGrade` | int | 家格 | 3（固定） |
| `Affiliation` | string | 所属（羽柴家など） | 「羽柴家」 |
| `AbilityCombat` | int | 個人戦闘能力 | ランダム（50-70） |
| `AbilityLeadership` | int | 統率 | ランダム（30-50） |
| `AbilityPolitics` | int | 政務 | ランダム（50-70） |
| `AbilityIntrigue` | int | 知略 | ランダム（50-70） |
| `Achievement` | int | 累積功績 | 0 |
| `Salary` | int | 俸給（月額・貫） | 100 |
| `Money` | int | 所持金（貫） | 50 |
| `AdvisorId` | string? | 補佐官ID（nullなら未任命） | null |
| `JubokuIds` | List\<string\> | 従僕IDリスト | 空リスト |
| `JubokuSlots` | int | 従僕枠数 | 3 |

**補足**:
- `Rank` enum: `Juboku`（従僕）、`Toshi`（徒士）、`Kumigashira`（組頭）、`Busho`（部将）、`Jidaisho`（侍大将・v0.7以降）
- 主人公はv0.5では`Toshi`（徒士）からスタート
- `JubokuSlots`は役職に応じて変動（徒士=3、組頭=2、部将=0）
- 徒士の初期統率は低め（30-50）、組頭昇格後に統率が重要になる（v0.6以降）

---

### 1.3 家臣データ構造

| フィールド名 | 型 | 説明 | 初期値 |
|------------|---|------|--------|
| `Id` | string | 家臣ID | 自動生成 |
| `Name` | string | 名前 | ランダム生成 |
| `Age` | int | 年齢 | ランダム（18-40） |
| `Rank` | enum `Rank` | 役職 | `Rank.Juboku` または `Rank.Toshi` |
| `AbilityCombat` | int | 個人戦闘能力（実値） | ランダム（30-80） |
| `AbilityLeadership` | int | 統率（実値） | ランダム（10-60） |
| `AbilityPolitics` | int | 政務（実値） | ランダム（30-80） |
| `AbilityIntrigue` | int | 知略（実値） | ランダム（30-80） |
| `Loyalty` | int | 忠誠値（0-100） | 役職により異なる（後述） |
| `Achievement` | int | 累積功績（徒士以上のみ） | 0 |
| `IsAdvisor` | bool | 補佐官フラグ | false |
| `AbilityDisclosure` | `AbilityDisclosureFlags` | 能力開示フラグ | すべてfalse |
| `CombatParticipationCount` | int | 戦闘同行回数 | 0 |
| `DutyParticipationCount` | int | 公務同行回数 | 0 |

**`AbilityDisclosureFlags` 構造**:
```
{
  CombatDisclosed: bool,        // 個人戦闘能力開示済み
  LeadershipDisclosed: bool,    // 統率開示済み
  PoliticsDisclosed: bool,      // 政務開示済み
  IntrigueDisclosed: bool,      // 知略開示済み
  FullDisclosed: bool           // 全能力開示済み（補佐官任命時）
}
```

**忠誠初期値**:
- 従僕（家内従者・長期雇用）: 70-90
- 従僕（契約雇用）: 50-70
- 徒士: 45-65

**能力値の傾向**:
- 従僕: 個人戦闘能力が高め、統率は低め（0-30）
- 徒士: 個人戦闘能力が主軸、統率は低め（10-40）
- 組頭: 統率が高め（40-70）、個人戦闘能力は補助的

---

### 1.4 日次ログデータ（DailyLog）

v0.4で実装済みだが、v0.5では以下を追加:

| フィールド名 | 型 | 説明 |
|------------|---|------|
| `Date` | DateTime | 日付 |
| `ActionType` | enum `ActionType` | 行動種別（公務/私事/戦闘） |
| `TaskName` | string | タスク名 |
| `Target` | string | 対象（村Aなど） |
| `Result` | string | 結果テキスト |
| `ParticipatingVassalIds` | List\<string\> | 参加家臣IDリスト（v0.5追加） |

---

### 1.5 月次サマリーデータ（MonthlySummary）

v0.4で実装済みだが、v0.5では以下を追加:

| フィールド名 | 型 | 説明 |
|------------|---|------|
| `Year` | int | 年 |
| `Month` | int | 月 |
| `IncomeTotal` | int | 総収入（村収入+俸給） |
| `ExpenseTotal` | int | 総支出（従僕給金+私事支出） |
| `AchievementMilitaryGain` | int | 軍事功増加量 |
| `AchievementPoliticalGain` | int | 政務功増加量 |
| `AchievementSecretGain` | int | 密功増加量 |
| `EvaluationChange` | int | 評価変動 |
| `PublicDutyCount` | int | 公務実施回数 |
| `PlayerPromoted` | bool | 主人公昇格フラグ（v0.5追加） |
| `PlayerNewRank` | enum `Rank`? | 主人公の新役職（昇格時のみ） |
| `VassalsPromoted` | List\<string\> | 昇格した家臣IDリスト（v0.5追加） |
| `LoyaltyChanges` | Dictionary\<string, int\> | 家臣ID→忠誠変動量（v0.5追加） |

---

## 2. 家臣団ロジック（役職系）

### 2.1 役職階層（単線構造）

```
従僕（Juboku）
  ↓
徒士（Toshi）
  ↓
組頭（Kumigashira）
  ↓
部将（Busho）
  ↓
侍大将（Jidaisho）※v0.7以降
```

**v0.5での範囲**:
- 主人公: 徒士 → 組頭 → 部将
- 家臣: 従僕 → 徒士 → 組頭

### 2.2 役職ごとの詳細定義

#### 従僕（Juboku）

**定義**: 家内従者。最下位役職。

**公務権限**: なし（公務実行不可）

**戦場での立場**: 主人公護衛。護衛小隊として主人公周囲で戦闘。

**主能力**: 個人戦闘能力

**統率**: ほぼゼロ〜低め（0-30）

**給金**: 主人公が支給（月10-20文、実装時は15文固定でも可）

**昇格**: 従僕→徒士は主人公が無条件で任命可能（功績不要）

**戦功**: 従僕の戦功はすべて主人公に100%集約される。従僕個人には功績が蓄積されない。

---

#### 徒士（Toshi）

**定義**: 正式武士の最下位。

**公務権限**: 基礎公務（治安維持、巡察、検地補助、普請補助、書状作成、情報収集）

**戦場での立場**: 前衛兵

**主能力**: 個人戦闘能力

**統率**: ほぼ無し〜低め（10-40）

**給金**: 主家（羽柴家など）から支給（月100-150文）

**昇格**: 徒士→組頭は功績＋主人公が組頭以上である必要

**戦功**: 個人功績として蓄積される

---

#### 組頭（Kumigashira）

**定義**: 小隊長。徒士を率いる下級指揮官。

**公務権限**: 中規模公務（現場指揮級）

**戦場での立場**: 小隊指揮

**主能力**: 統率

**個人戦闘能力**: サブ要素

**給金**: 主家から支給（月300-400文）

**統率の効果**:
- 小隊行動（前進・退却・斬り込み）の判断
- 徒士の死亡率低減
- 敵への被害増加
- ※v0.5では統率の詳細効果は簡易実装、v0.6で本格化

---

#### 部将（Busho）

**定義**: 中隊長。家中の中堅層。

**公務権限**: 広域公務

**戦場での立場**: 中隊指揮（v0.6以降で詳細実装）

**主能力**: 統率（高値）

**個人戦闘能力**: 補助的

**給金**: 主家から支給（月700-900文）

**従僕枠**: 0（部将は従僕を持たない）

---

### 2.3 従僕枠の数と変動ルール

| 主人公の役職 | 従僕枠数 |
|------------|---------|
| 徒士 | 3 |
| 組頭 | 2 |
| 部将 | 0 |
| 侍大将（v0.7以降） | 0 |

**変動タイミング**: 主人公昇格時に即座に変更

**従僕枠超過時の処理**:
- 主人公が組頭に昇格し、従僕が3人いる場合 → 1人を徒士に昇格させるか、解雇する必要がある
- 主人公が部将に昇格し、従僕がいる場合 → すべて徒士に昇格させるか、解雇する必要がある
- **実装方針**: 昇格時に自動的に「従僕→徒士昇格」を提案するダイアログを表示

---

### 2.4 任命権ルール

**ルール**: 主人公は自分の役職未満まで家臣を任命昇格できる

| 主人公の役職 | 従僕→徒士 | 徒士→組頭 | 組頭→部将 |
|------------|----------|----------|----------|
| 徒士 | ○ | × | × |
| 組頭 | ○ | ○ | × |
| 部将 | ○ | ○ | ○（v0.7以降） |

**実装時の判定式**:
```
昇格可能 = (家臣の現役職 < 主人公の役職)
```

---

## 3. 戦闘ロジック（護衛小隊 / 個人戦闘能力）

### 3.1 護衛小隊戦力の算出式

```
護衛小隊戦力 = 主人公個人戦闘能力
             + (筆頭従僕個人戦闘能力 × 0.2)
             + (その他従僕個人戦闘能力合計 × 0.1)
```

**筆頭従僕の定義**: `JubokuIds`リストの最初の要素

**重要**: 統率は護衛小隊戦力に影響しない。純粋に「個人戦闘能力」のみで計算。

**実装例（疑似コード）**:
```
totalPower = player.AbilityCombat

if (jubokuList.Count > 0) {
    leadJuboku = jubokuList[0]
    totalPower += leadJuboku.AbilityCombat * 0.2
}

if (jubokuList.Count > 1) {
    for (i = 1; i < jubokuList.Count; i++) {
        totalPower += jubokuList[i].AbilityCombat * 0.1
    }
}

return totalPower
```

---

### 3.2 戦功の集計ルール

**従僕分の戦功**:
- すべて主人公の`Achievement`に加算
- 従僕個人の`Achievement`は増加しない（従僕は功績を持たない）

**徒士・組頭の戦功**:
- 個人の`Achievement`に加算
- 主人公の`Achievement`には加算されない

---

### 3.3 戦死・負傷判定の計算フロー

**戦死率の優先順位**（高い順）:
1. 筆頭従僕（最も危険）
2. その他従僕（中間）
3. 徒士・組頭（役職に応じて）
4. 主人公（最も安全）

**実装方針**:
- 戦闘結果に応じて、各キャラクターに対して戦死判定を実行
- 判定式（疑似コード）:
```
deathRate = baseDeathRate * (1.0 - battleResult) * characterRiskFactor

characterRiskFactor:
  主人公: 0.3
  筆頭従僕: 1.5
  その他従僕: 1.0
  徒士: 0.8
  組頭: 0.7
```

**v0.5簡易版**: 戦死判定は低確率に抑え、ゲームバランスを優先

---

### 3.4 統率が戦場に影響するのは組頭以上（v0.6以降）

**v0.5での扱い**:
- 統率は戦闘ロジックにほぼ影響しない
- 組頭・部将の統率値は保持されるが、戦場AIには反映されない

**v0.6以降の拡張予定**:
- 組頭の統率が小隊の死亡率低減に影響
- 部将の統率が中隊の行動最適化に影響
- 統率が低い組頭は昇格を躊躇するべき、という判断材料になる

---

## 4. 補佐官ロジック（政務・知略専用）

### 4.1 補佐官候補の条件

**条件**:
- 家臣であれば誰でも補佐官候補
- 忠誠条件なし
- 役職条件なし（従僕でも可）

**補佐官枠**: 1名のみ

---

### 4.2 能力差分40%補正の計算手順

**対象能力**:
- 政務（AbilityPolitics）
- 知略（AbilityIntrigue）
- ※軍略は別紙に記載があるが、v0.5では知略と統合扱い

**補正対象外**:
- **個人戦闘能力（AbilityCombat）**
- **統率（AbilityLeadership）**

**計算式**:
```
補正値 = max(補佐官能力 - 主人公能力, 0) × 0.4
```

**実装例（疑似コード）**:
```
if (player.AdvisorId != null) {
    advisor = vassals.Find(v => v.Id == player.AdvisorId)
    
    politicsBonus = max(advisor.AbilityPolitics - player.AbilityPolitics, 0) * 0.4
    intrigueBonus = max(advisor.AbilityIntrigue - player.AbilityIntrigue, 0) * 0.4
    
    effectivePolitics = player.AbilityPolitics + politicsBonus
    effectiveIntrigue = player.AbilityIntrigue + intrigueBonus
    
    // 個人戦闘能力と統率は補正されない
    effectiveCombat = player.AbilityCombat  // 補正なし
    effectiveLeadership = player.AbilityLeadership  // 補正なし
}
```

---

### 4.3 任命・解除時の処理

**任命時**:
1. `player.AdvisorId`に家臣IDを設定
2. `vassal.IsAdvisor = true`
3. **能力全開示**: `vassal.AbilityDisclosure.FullDisclosed = true`、すべての個別フラグもtrue
4. 忠誠+5（補佐官任命は恩義として扱う）

**解除時**:
1. `player.AdvisorId = null`
2. `vassal.IsAdvisor = false`
3. 能力開示状態は維持（一度見えた能力は見え続ける）
4. 忠誠-3（解任は軽微な不満）

---

### 4.4 補佐官任命による能力全開示

**仕様**:
- 補佐官に任命された瞬間、4能力すべてが開示される
- `AbilityDisclosure.FullDisclosed = true`
- 個別フラグ（CombatDisclosed, LeadershipDisclosed, PoliticsDisclosed, IntrigueDisclosed）もすべてtrue

**理由**: 補佐官として働く以上、主人公はその能力を完全に把握する必要がある

---

## 5. 出世ロジック（主人公・家臣）

### 5.1 主人公の昇格条件

#### 徒士 → 組頭

**条件**:
- 累積功績 >= 200（家格3の場合、通常より低め）

**効果**:
- `player.Rank = Rank.Kumigashira`
- `player.JubokuSlots = 2`
- `player.Salary = 300`（暫定値）
- 忠誠変動なし（主人公自身の昇格）

#### 組頭 → 部将

**条件**:
- 累積功績 >= 500
- 組頭として一定期間（v0.5では期間条件なし、功績のみ）

**効果**:
- `player.Rank = Rank.Busho`
- `player.JubokuSlots = 0`
- `player.Salary = 700`（暫定値）

---

### 5.2 家臣の昇格条件

#### 従僕 → 徒士

**条件**:
- 主人公の判断のみ（無条件）
- 功績不要

**効果**:
- `vassal.Rank = Rank.Toshi`
- `vassal.Loyalty += 10`（昇格は大きな恩義）
- `vassal.Achievement = 0`（徒士として功績カウント開始）

**実装**: 家臣一覧画面に「徒士に昇格」ボタンを配置

#### 徒士 → 組頭

**条件**:
1. 家臣の累積功績 >= 30（徒士としての戦功）
2. 主人公が組頭以上（`player.Rank >= Rank.Kumigashira`）
3. ※v0.5では統率条件なし、v0.6で統率条件を追加予定

**効果**:
- `vassal.Rank = Rank.Kumigashira`
- `vassal.Loyalty += 12`
- 功績はリセットしない（継続）

**実装**: 条件を満たした家臣のみ「組頭に昇格」ボタンが有効化

---

### 5.3 昇格時の効果まとめ

| 昇格 | 忠誠変動 | 俸給変動 | 従僕枠変動 | 功績リセット | 主能力の変化 |
|------|---------|---------|-----------|------------|------------|
| 主人公：徒士→組頭 | なし | +200 | 3→2 | なし | 個人戦闘→統率重視 |
| 主人公：組頭→部将 | なし | +400 | 2→0 | なし | 統率（高値） |
| 家臣：従僕→徒士 | +10 | なし | なし | 0に設定 | 個人戦闘維持 |
| 家臣：徒士→組頭 | +12 | なし | なし | なし | 個人戦闘→統率重視 |

---

## 6. 忠誠・能力開示ロジック

### 6.1 忠誠値の増減要因

#### 増加要因

| 要因 | 増加量 | タイミング |
|------|--------|----------|
| 昇格（従僕→徒士） | +8〜+15 | 昇格時 |
| 昇格（徒士→組頭） | +8〜+15 | 昇格時 |
| 補佐官任命 | +5 | 任命時 |
| 主人公の大活躍（戦争） | +3〜+10 | 戦闘勝利時 |
| 公務成功の積み重ね | +1〜+3 | 月次処理 |

#### 減少要因

| 要因 | 減少量 | タイミング |
|------|--------|----------|
| 補佐官解任 | -3 | 解任時 |
| 主人公の失敗（公務） | 0〜-5 | 月次処理 |
| 主人公の敗戦 | -5〜-10 | 戦闘敗北時 |

---

### 6.2 忠誠10以下での出奔条件

**条件**:
- 忠誠 <= 10
- かつ、以下のいずれか:
  - 主人公が連続で公務失敗
  - 主人公が大敗戦
  - 家臣が長期間放置されている

**出奔処理**:
- 家臣リストから削除
- ログに「〇〇が出奔しました」と記録
- 補佐官だった場合、`player.AdvisorId = null`

**v0.5簡易版**: 出奔のみ実装、反乱・寝返りはv0.8以降

---

### 6.3 能力開示の段階ルール

#### 初期状態（雇用時）

**開示情報**:
- 名前
- 年齢

**非開示情報**:
- すべての能力値（UI上は「？」表示）

---

#### 戦闘同行による開示

**条件**: 戦闘に参加するたび、`CombatParticipationCount++`

**開示タイミング**:
- 3回目の戦闘参加で`AbilityDisclosure.CombatDisclosed = true`
- 個人戦闘能力が表示される

**注意**: 統率は戦闘同行では開示されない（統率は公務同行または補佐官任命で開示）

---

#### 公務同行による開示

**条件**: 公務を担当するたび、`DutyParticipationCount++`

**開示タイミング**:
- 3回目の公務参加で`AbilityDisclosure.PoliticsDisclosed = true`
- 政務が表示される
- 6回目で`AbilityDisclosure.IntrigueDisclosed = true`、`AbilityDisclosure.LeadershipDisclosed = true`
- 知略と統率が表示される

**注意**: v0.5では公務同行システムは簡易実装。徒士以上の家臣が公務を実行した場合にカウント。

---

#### 補佐官任命による即時開示

**仕様**:
- 補佐官任命時、`AbilityDisclosure.FullDisclosed = true`
- すべての個別フラグもtrue
- 4能力すべてが即座に表示される

---

#### 開示の優先順位

1. 個人戦闘能力（戦闘同行で最優先）
2. 政務（公務同行で優先）
3. 知略（公務同行で開示）
4. 統率（公務同行で開示、v0.6以降で重要度UP）

---

## 7. 月次処理ロジック

### 7.1 月次処理の実行順序（疑似コード）

```
function ProcessMonthly() {
    // 1. 公務判定
    publicDutyResult = EvaluatePublicDuty(selectedDuty, player, advisor)
    
    // 2. 私事の結果反映
    privateTaskResult = EvaluatePrivateTask(selectedTask, villages)
    
    // 3. 戦功集計（戦闘があった場合）
    if (battleOccurred) {
        battleResults = ProcessBattle(player, jubokuList, toshiList)
    }
    
    // 4. 功績計算
    achievementGain = CalculateAchievementGain(publicDutyResult, battleResults)
    player.Achievement += achievementGain.total
    
    // 徒士以上の家臣にも個別功績を加算
    foreach (vassal in vassals where vassal.Rank >= Rank.Toshi) {
        vassal.Achievement += vassal.individualAchievement
    }
    
    // 5. 忠誠更新
    foreach (vassal in vassals) {
        loyaltyChange = CalculateLoyaltyChange(vassal, publicDutyResult, battleResults)
        vassal.Loyalty += loyaltyChange
        vassal.Loyalty = Clamp(vassal.Loyalty, 0, 100)
    }
    
    // 6. 補佐官成長（v0.5では微量、v0.6で詳細化）
    if (player.AdvisorId != null) {
        advisor = GetAdvisor(player.AdvisorId)
        advisor.AbilityPolitics += Random(0, 1)  // 微量成長
        advisor.AbilityIntrigue += Random(0, 1)  // 微量成長
        // 個人戦闘能力と統率は成長しない
    }
    
    // 7. 出世判定（主人公）
    playerPromoted = CheckPlayerPromotion(player)
    if (playerPromoted) {
        PromotePlayer(player)
    }
    
    // 8. 家臣昇格チェック（徒士→組頭）
    vassalsPromoted = CheckVassalPromotionEligibility(vassals, player)
    // ※実際の昇格はプレイヤーの任命操作で実行
    
    // 9. 俸給処理
    player.Money += player.Salary  // 主家から俸給受領
    
    foreach (juboku in jubokuList) {
        player.Money -= 15  // 従僕給金支払い
    }
    
    // 村収入（v0.4で実装済み）
    player.Money += CalculateVillageIncome(villages)
    
    // 私事支出
    player.Money -= privateTaskResult.expense
    
    // 10. 月次サマリー作成
    summary = CreateMonthlySummary(...)
    
    // 11. 出奔判定
    CheckAndProcessDesertion(vassals)
    
    // 12. 翌月へ
    AdvanceMonth()
}
```

---

### 7.2 各処理の詳細

#### 公務判定（EvaluatePublicDuty）

**入力**:
- 選択された公務
- 主人公能力（政務・知略）
- 補佐官補正

**処理**:
```
effectiveAbility = player.AbilityPolitics + advisorBonus.politics

successRate = CalculateSuccessRate(effectiveAbility, dutyDifficulty)

if (Random() < successRate) {
    result = "成功"
    achievementGain = dutyAchievementValue
} else {
    result = "失敗"
    achievementGain = 0
}
```

**出力**:
- 成功/失敗
- 功績増加量

**注意**: 個人戦闘能力と統率は公務判定に影響しない

---

#### 功績計算（CalculateAchievementGain）

**公務成功**: +5〜+15（公務の種類による）

**戦功**:
- 小規模戦闘勝利: +20
- 中規模戦闘勝利: +50
- 大規模戦闘勝利: +100

**従僕の戦功**: すべて主人公に加算

---

#### 忠誠更新（CalculateLoyaltyChange）

**基本ルール**:
- 公務成功: 全家臣 +1
- 主人公の大活躍: 全家臣 +3〜+10
- 公務失敗: 全家臣 0〜-2

---

#### 出世判定（CheckPlayerPromotion）

```
if (player.Rank == Rank.Toshi && player.Achievement >= 200) {
    return true  // 徒士→組頭
}

if (player.Rank == Rank.Kumigashira && player.Achievement >= 500) {
    return true  // 組頭→部将
}

return false
```

---

#### 家臣昇格チェック（CheckVassalPromotionEligibility）

```
eligibleVassals = []

foreach (vassal in vassals where vassal.Rank == Rank.Toshi) {
    if (vassal.Achievement >= 30 && player.Rank >= Rank.Kumigashira) {
        eligibleVassals.Add(vassal)
    }
}

return eligibleVassals
```

**注意**: 実際の昇格はプレイヤーが家臣一覧画面で「昇格」ボタンを押すことで実行

---

## 8. 画面I/O（UIとロジック間データ入出力）

### 8.1 メイン画面（MainScreen）

**表示情報**:
- 主人公の役職（`player.Rank`）
- 主人公の名前（`player.Name`）
- 主人公の所属（`player.Affiliation`）
- 所持金（`player.Money`）
- 累積功績（`player.Achievement`）
- 従僕枠（`player.JubokuSlots` / 現在の従僕数）
- 補佐官情報（`player.AdvisorId`がnullでなければ補佐官名を表示）
- 現在の日付（年/月/日）

**操作**:
- 「公務を行う」ボタン → 公務選択画面へ遷移
- 「私事を行う」ボタン → 私事選択画面へ遷移
- 「家臣一覧」ボタン → 家臣一覧画面へ遷移
- 「補佐官設定」ボタン → 補佐官設定画面へ遷移

**API**:
- `GetPlayerStatus()` → 主人公の全情報を返す
- `GetCurrentDate()` → 現在の日付を返す
- `GetJubokuCount()` → 現在の従僕数を返す
- `GetAdvisorName()` → 補佐官の名前を返す（未任命ならnull）

---

### 8.2 家臣一覧画面（VassalListScreen）

**表示情報**（テーブル形式）:
- 名前（`vassal.Name`）
- 年齢（`vassal.Age`）
- 役職（`vassal.Rank`）
- 個人戦闘能力（開示済みなら数値、未開示なら「？」）
- 統率（開示済みなら数値、未開示なら「？」）
- 政務（開示済みなら数値、未開示なら「？」）
- 知略（開示済みなら数値、未開示なら「？」）
- 忠誠（`vassal.Loyalty`）
- 功績（`vassal.Achievement`、徒士以上のみ）
- 補佐官バッジ（`vassal.IsAdvisor`）
- 筆頭従僕バッジ（`JubokuIds[0]`の場合）

**操作**:
- 各家臣の行をクリック → 家臣詳細画面へ遷移
- 「従僕→徒士昇格」ボタン（従僕のみ表示）
- 「徒士→組頭昇格」ボタン（条件を満たした徒士のみ有効化）

**API**:
- `GetVassalList()` → 全家臣のリストを返す
- `PromoteVassalToToshi(vassalId)` → 従僕を徒士に昇格
- `PromoteVassalToKumigashira(vassalId)` → 徒士を組頭に昇格（条件チェック含む）

---

### 8.3 家臣詳細画面（VassalDetailScreen）

**表示情報**:
- 名前、年齢、役職
- 4能力値（開示済みのもののみ数値表示、未開示は「？」）
  - 個人戦闘能力
  - 統率
  - 政務
  - 知略
- 忠誠値
- 功績（徒士以上）
- 戦闘参加回数（`CombatParticipationCount`）
- 公務参加回数（`DutyParticipationCount`）
- 補佐官フラグ

**操作**:
- 「戻る」ボタン → 家臣一覧画面へ戻る
- 「補佐官に任命」ボタン（補佐官未任命時のみ表示）
- 「補佐官を解任」ボタン（この家臣が補佐官の場合のみ表示）

**API**:
- `GetVassalDetail(vassalId)` → 指定家臣の詳細情報を返す
- `AppointAdvisor(vassalId)` → 補佐官に任命
- `DismissAdvisor()` → 補佐官を解任

---

### 8.4 補佐官設定画面（AdvisorSettingScreen）

**表示情報**:
- 現在の補佐官（任命済みなら名前と能力、未任命なら「未任命」）
- 補佐官候補リスト（全家臣）
  - 名前、年齢、役職
  - 4能力値（開示済みのもののみ）
  - 補正値プレビュー（この家臣を補佐官にした場合の差分40%補正を表示）
    - 政務補正: `max(候補の政務 - 主人公の政務, 0) × 0.4`
    - 知略補正: `max(候補の知略 - 主人公の知略, 0) × 0.4`
    - ※個人戦闘能力と統率は補正対象外であることを明示

**操作**:
- 各候補の「任命」ボタン → 補佐官に任命
- 現在の補佐官の「解任」ボタン → 補佐官を解任

**API**:
- `GetAdvisorInfo()` → 現在の補佐官情報を返す
- `GetAdvisorCandidates()` → 全家臣のリストと補正プレビューを返す
- `AppointAdvisor(vassalId)` → 補佐官に任命
- `DismissAdvisor()` → 補佐官を解任

---

### 8.5 公務選択画面（PublicDutySelectionScreen）

**表示情報**:
- 6種類の公務リスト
  - 公務名
  - 難易度
  - 期待功績
  - 成功率プレビュー（主人公の政務能力+補佐官補正で計算）

**操作**:
- 各公務の「選択」ボタン → 公務を選択し、月次処理へ

**API**:
- `GetPublicDutyList()` → 公務リストと成功率プレビューを返す
- `SelectPublicDuty(dutyId)` → 公務を選択

---

### 8.6 月次サマリー画面（MonthlySummaryScreen）

**表示情報**:
- 年月
- 収入合計（村収入+俸給）
- 支出合計（従僕給金+私事支出）
- 功績増加量（軍事功/政務功/密功）
- 評価変動
- 公務実施回数
- 主人公昇格フラグ（昇格した場合、「組頭に昇格しました！」などのメッセージ）
- 家臣昇格リスト（昇格した家臣がいれば表示）
- 忠誠変動（主要な変動があった家臣のみ表示）

**操作**:
- 「翌月へ」ボタン → 翌月の処理を開始

**API**:
- `GetMonthlySummary()` → 月次サマリーデータを返す
- `ProceedToNextMonth()` → 翌月へ進む

---

## 9. バリデーション / 例外処理

### 9.1 昇格できないケース

#### 主人公の昇格

**徒士→組頭**:
- 功績不足（`player.Achievement < 200`）
  - エラーメッセージ: 「功績が不足しています。（現在: {player.Achievement} / 必要: 200）」

**組頭→部将**:
- 功績不足（`player.Achievement < 500`）
  - エラーメッセージ: 「功績が不足しています。（現在: {player.Achievement} / 必要: 500）」

#### 家臣の昇格

**従僕→徒士**:
- 制約なし（無条件昇格）

**徒士→組頭**:
- 家臣の功績不足（`vassal.Achievement < 30`）
  - エラーメッセージ: 「{vassal.Name}の功績が不足しています。（現在: {vassal.Achievement} / 必要: 30）」
- 主人公の役職不足（`player.Rank < Rank.Kumigashira`）
  - エラーメッセージ: 「主人公が組頭以上でなければ、家臣を組頭に昇格させることはできません。」

---

### 9.2 従僕枠がいっぱいの時の挙動

**ケース**: 従僕枠が3/3で、新たに従僕を雇用しようとした場合

**処理**:
- エラーメッセージ: 「従僕枠がいっぱいです。（現在: {jubokuCount} / 上限: {player.JubokuSlots}）」
- 雇用を拒否

**ケース**: 主人公が昇格し、従僕枠が減少した場合（例: 徒士→組頭で3→2）

**処理**:
1. 昇格処理を実行
2. 従僕枠超過を検出
3. ダイアログ表示: 「従僕枠が減少しました。{超過人数}人を徒士に昇格させるか、解雇してください。」
4. プレイヤーが選択するまで次の処理に進めない

---

### 9.3 補佐官が戦死・離脱した場合の挙動

**戦死**:
1. 家臣リストから削除
2. `player.AdvisorId = null`
3. ログに「補佐官{vassal.Name}が戦死しました。」と記録
4. 次回の公務から補佐官補正なし

**離脱（出奔）**:
1. 家臣リストから削除
2. `player.AdvisorId = null`
3. ログに「補佐官{vassal.Name}が出奔しました。」と記録

---

### 9.4 v0.5で「未実装として無視する」ケース

以下の要素はv0.5では実装せず、v0.6以降に回す:

- 大名家官職（奉行、家老など）
- 派閥システム
- 評定イベント
- 家臣の部将昇格（組頭までで止める）
- 詳細戦闘フェイズ（戦術選択など）
- 統率の戦場AIへの本格反映（v0.6以降）
- 長期計画（年次中期計画）
- 人口・領地の詳細シミュレーション
- 引き抜きシステム（家↔家の交渉）
- 寺社・商人紹介による家臣採用
- 貸し借り（恩義・負債）の詳細計算
- 裏切りAI（合戦中の寝返りなど）

**実装方針**: これらの機能に関連するUIやロジックは一切実装しない。

---

### 9.5 不明点・未定義事項

以下の項目はv0.5では未定義のため、v0.6以降で拡張:

- 統率が戦場AIに与える具体的な影響（v0.6で数値化）
- 補佐官の成長速度の詳細（v0.6で定義）
- 組頭昇格時の統率条件（v0.6で追加予定）
- 徒士・組頭の公務同行システムの詳細（v0.5では簡易実装）

---

## 補足事項

### v0.5の実装優先順位

1. **最優先**: データモデル（4能力）、家臣団、役職、従僕枠、補佐官、出世判定
2. **高優先**: 忠誠、能力開示、月次処理フロー
3. **中優先**: 従僕戦闘、戦功集計
4. **低優先**: UI詳細、エラーメッセージの多言語化

### v0.6以降への引き継ぎ事項

- 統率の戦場AIへの本格反映
- 補佐官成長の数値化
- 組頭昇格時の統率条件追加
- 戦闘AIの詳細化
- 派閥・評定システムの導入
- 大名家との関係強化

### 能力体系の設計思想（重要）

- **個人戦闘能力**: 従僕・徒士の主軸。護衛小隊戦力に影響。補佐官補正対象外。
- **統率**: 組頭・部将の主軸。v0.5では保持のみ、v0.6で戦場AIに反映。補佐官補正対象外。
- **政務**: 公務成功率に影響。補佐官補正対象。
- **知略**: 公務判断に影響。補佐官補正対象。

この4能力の分離により、「戦闘特化の従僕」「指揮特化の組頭」「政務特化の補佐官」という明確な役割分担が成立する。

---

**ここまでが仕様書です。次の指示待ち。**
