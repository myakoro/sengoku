# 戦国立身出世SLG v0.9 仕様書

## 第1章：概要（v0.9の目的）

### 1.1 バージョン目的

v0.9は戦場システムの基礎構造を確定し、v1.0〜1.1の陣形・AI強化・戦場UIの土台を作ることを目的とする。

### 1.2 完成させる要素

本バージョンで完成させる要素は以下の通り：

- 25・100・300人階層の隊構造
- 押し合い（戦闘処理）の数学モデル
- 状態モデル（訓練度・実戦度・疲労・士気）
- 小隊／中隊／大隊のAI行動ロジック
- 士気崩壊 → 追撃 → 損耗（死・廃兵・負傷・逃散）処理
- 損耗に応じた人口減少ロジック
- 戦功（功績）モデルの基本形

### 1.3 スコープ

内部ロジックの実装を範囲内とする。UIは別途HTMLモックとして提供される。

---

## 第2章：システム全体構造

### 2.1 データ流れ

```
[戦闘開始]
  ↓
[隊編成データ読み込み]
  ↓
[押し合いサイクル開始]
  ├→ 有効戦闘力算出
  ├→ 勝敗判定
  ├→ 士気・疲労更新
  ├→ 損耗処理（少量）
  └→ 崩壊判定
  ↓
[中隊AI判断]
  ├→ ローテーション
  ├→ 自律後退
  └→ 大隊への報告
  ↓
[大隊AI判断]
  ├→ 中隊ローテ指示
  ├→ 段階的後退
  ├→ 総退却
  └→ 追撃判定
  ↓
[追撃処理]
  ├→ 追撃条件判定
  ├→ 追撃強度決定
  └→ 損耗処理（大量）
  ↓
[損耗→人口反映]
  ↓
[戦功計算]
  ↓
[戦闘結果サマリー生成]
```

### 2.2 戦闘処理の基本フロー

1. **初期化**: 大隊・中隊・小隊の状態を初期化
2. **押し合いサイクル**: 有効戦闘力を算出し、勝敗を判定
3. **状態更新**: 士気・疲労を更新
4. **AI判断**: 小隊・中隊・大隊の各レベルでAI判断を実行
5. **崩壊処理**: 士気0の隊を崩壊させる
6. **追撃処理**: 崩壊した敵への追撃を判定・実行
7. **損耗処理**: 死亡・廃兵・負傷・逃散を判定
8. **人口反映**: 出身知行地IDに基づき人口を減少
9. **戦功計算**: 4軸戦功を計算し、戦局補正を適用
10. **結果生成**: 戦闘結果サマリーを生成

### 2.3 UIとの結合点

- **入力**: 軍事編成画面からの隊編成データ
- **状態表示**: 隊状態パネルへの訓練度・実戦度・疲労・士気の出力
- **戦闘表示**: 戦場UIへの押し合い状況・ローテーション・崩壊・追撃の出力
- **結果表示**: 兵士損耗レポート・家臣戦功レポートへのデータ出力

---

## 第3章：データモデル定義

### 3.1 兵データ

#### 3.1.1 基本構造

```
Soldier {
  id: string
  name: string
  type: SoldierType (徒士/馬上衆/従僕)
  originVillageId: string
  combatPower: number
  isOwn: boolean (自家兵/借り兵)
  squadId: string
}
```

#### 3.1.2 兵種別特性

**徒士**:
- 小隊戦力に個人戦力値を加算
- 死亡時: 小隊戦力減少、士気−2〜4

**馬上衆**:
- 徒士より高い個人戦力値を加算
- 死亡時: 小隊戦力減少、士気−2〜5（徒士より重い）

**従僕**:
- 戦力に含まれない
- 死亡時: 小隊に影響なし、小頭の精度一時低下

### 3.2 出身知行地ID

各兵は必ず出身知行地IDを持つ。

```
originVillageId: string
```

このIDは損耗処理時に人口減少を反映するために使用される。

### 3.3 小隊（25人単位）

```
Squad {
  id: string
  commanderId: string (小頭)
  soldiers: Soldier[]
  basePower: number
  training: number (0-100)
  experience: number (0-100)
  fatigue: number (0-100)
  morale: number (0-100)
  formation: number (0-100)
  position: Position (前線/後衛)
}
```

### 3.4 中隊（100人）

```
Company {
  id: string
  commanderId: string (組頭)
  commanderPersonality: Personality (慎重/標準/猪突)
  squads: Squad[]
  averageTraining: number
  averageExperience: number
  averageFatigue: number
  averageMorale: number
  position: Position (前線/後衛)
}
```

### 3.5 大隊（300人）

```
Battalion {
  id: string
  commanderId: string (足軽大将)
  companies: Company[]
  totalStrength: number
  averageTraining: number
  averageExperience: number
  averageFatigue: number
  averageMorale: number
}
```

### 3.6 状態パラメータ

#### 訓練度（Training）
- 範囲: 0-100
- 用途: 戦闘力の最大値を引き上げる
- 補正式: `0.5 + (訓練度 / 200)`

#### 実戦度（Experience）
- 範囲: 0-100
- 用途: 揺らぎの安定度を向上
- 補正式: `0.6 + (実戦度 / 200)`

#### 疲労（Fatigue）
- 範囲: 0-100
- 用途: 戦闘力にペナルティを付与

| 疲労 | 補正 |
|------|------|
| 0-49 | 0% |
| 50-79 | -10% |
| 80-99 | -20% |
| 100 | -40% |

#### 士気（Morale）
- 範囲: 0-100
- 用途: 崩壊判定のトリガー

| 士気 | 状態 |
|------|------|
| 40以上 | 良好 |
| 20-39 | 軽デバフ |
| 1-19 | 重デバフ |
| 0 | 即崩壊 |

#### 隊列維持（Formation）
- 範囲: 0-100
- 用途: 有効戦闘力に軽微反映
- 算出: 訓練度と中隊指揮の結果

### 3.7 損耗データ

```
Casualty {
  soldierId: string
  type: CasualtyType (死亡/廃兵/負傷/逃散)
  originVillageId: string
  isOwn: boolean
  squadId: string
  phase: Phase (押し合い中/追撃)
}
```

#### 損耗種別

**死亡**: 人口−1、兵力減少
**廃兵**: 人口−1、兵力減少
**負傷**: 人口影響なし、治療後復帰
**逃散**: 人口−1、兵力減少

### 3.8 戦功データ

```
Achievement {
  vassalId: string
  vassalName: string
  rank: Rank
  moraleDamage: number
  collapseBonus: number
  pursuitDamage: number
  efficiencyBonus: number
  battleModifier: number
  total: number
}
```

---

## 第4章：ゲームロジック（仕様化）

### 4.1 押し合い

#### 4.1.1 有効戦闘力の算出

```
有効戦闘力 = 基礎戦力 × 訓練補正 × 実戦補正 × 疲労補正 × 士気補正 × 揺らぎ
```

**基礎戦力**:
```
基礎戦力 = 小隊基本戦力 + Σ(徒士個人戦力) + Σ(馬上衆個人戦力)
```

**訓練補正**:
```
訓練補正 = 0.5 + (訓練度 / 200)
```

**実戦補正**:
```
実戦補正 = 0.6 + (実戦度 / 200)
```

**疲労補正**:
```
疲労補正 = {
  1.0    (疲労 0-49)
  0.9    (疲労 50-79)
  0.8    (疲労 80-99)
  0.6    (疲労 100)
}
```

**士気補正**:
```
士気補正 = {
  1.0    (士気 40以上)
  0.9    (士気 20-39)
  0.7    (士気 1-19)
  0.0    (士気 0)
}
```

**揺らぎ**:
```
揺らぎ = 0.85 + (random(0, 0.3) × (1 - 実戦度/100))
```

#### 4.1.2 勝敗判定

```
戦力差 = 自軍有効戦闘力 - 敵軍有効戦闘力

判定 = {
  勝ち    (戦力差 > 50)
  拮抗    (戦力差 -50〜50)
  負け    (戦力差 < -50)
}
```

#### 4.1.3 士気・疲労更新

**勝ち**:
- 自軍士気: +1〜3
- 自軍疲労: +2〜4
- 敵軍士気: -3〜5
- 敵軍疲労: +3〜6

**拮抗**:
- 両軍士気: ±0〜1
- 両軍疲労: +2〜3

**負け**:
- 自軍士気: -3〜5
- 自軍疲労: +3〜6
- 敵軍士気: +1〜3
- 敵軍疲労: +2〜4

#### 4.1.4 押し合い中の損耗

押し合い中の死者は0.1〜3％。

```
死亡数 = floor(小隊人数 × random(0.001, 0.03))
```

### 4.2 状態補正

状態補正は有効戦闘力算出時に適用される。詳細は4.1.1を参照。

### 4.3 自律後退

#### 4.3.1 小隊の自律後退条件

以下のいずれかを満たす場合、小隊は自律的に後退する：

- 士気20以下
- 疲労90以上

#### 4.3.2 自律後退の処理

1. 小隊を前線から後衛に移動
2. 中隊に報告
3. 中隊は予備小隊を前線に投入

### 4.4 中隊ローテ

#### 4.4.1 ローテの基準（性格差）

中隊指揮官の性格によってローテーション判断の疲労基準が異なる：

- **慎重**: 疲労70
- **標準**: 疲労80
- **猪突**: 疲労90

#### 4.4.2 ローテの実行

1. 前線小隊の疲労が基準値に達する
2. 中隊AIがローテを判断
3. 前線小隊と後衛小隊を交代
4. 交代した小隊は休息（疲労回復）

### 4.5 大隊判断

#### 4.5.1 ローテ判定

以下のいずれかでローテーションを実施：

- 前線中隊疲労80以上
- 士気30未満
- 連続押し負け
- 後衛中隊が存在する

#### 4.5.2 段階的後退（退き口）

以下のいずれかで段階的後退を実施：

- 大隊平均士気30未満
- 前線中隊2つが士気20未満
- 中隊控えゼロで、前線状態が限界

#### 4.5.3 総退却（全軍離脱）

以下のいずれかで総退却を実施：

- **大隊平均士気20未満**（正式仕様）
- **前線2つが士気20未満**（正式仕様）
- 総兵力30%未満

**注**: 設計書では「士気10未満」と記載されていたが、正式仕様は「士気20未満」である。

### 4.6 崩壊

#### 4.6.1 崩壊条件

士気0 → 崩壊確定 → 中隊離脱

#### 4.6.2 崩壊処理

1. 中隊の士気が0になる
2. 中隊を崩壊状態に設定
3. 中隊を戦場から離脱
4. 敵大隊AIが追撃判定を開始

### 4.7 追撃（条件・強度・損耗）

#### 4.7.1 追撃条件

以下の条件をすべて満たす場合に追撃を実施：

- 自軍疲労 < 60
- 自軍士気 ≥ 50
- 敵が完全崩壊（士気0）
- **地形が追撃可能**（内部ロジックのみ、UI表示なし）

**注**: 指揮官性格は使用しない。

#### 4.7.2 追撃強度

以下の要素で追撃強度（P1〜P3の3段階）を決定：

- 自軍疲労
- 自軍士気
- 敵壊乱度
- **地形**（内部ロジックのみ、UI表示なし）

**P1（弱追撃）**:
- 自軍疲労: 50-59
- 自軍士気: 50-69
- 敵損耗: 5-10%

**P2（中追撃）**:
- 自軍疲労: 30-49
- 自軍士気: 70-84
- 敵損耗: 10-20%

**P3（強追撃）**:
- 自軍疲労: 0-29
- 自軍士気: 85-100
- 敵損耗: 20-30%

#### 4.7.3 追撃側の損耗

追撃側も軽微な損耗を受ける：

- **死亡**: 0〜0.5%
- **負傷**: 2〜5%

**注**: 「軽微な損耗」とぼかさず、数値を明示する。

#### 4.7.4 追撃時の損耗内訳

```
死亡：〜5%
廃兵：〜5%
負傷（治療後復帰）：10〜15%
逃散：〜5%
```

最大損耗は30%。

### 4.8 損耗 → 人口反映

#### 4.8.1 人口減少対象

人口から減少するのは以下のみ：

- 死亡
- 廃兵
- 逃散

負傷は人口を減らさない。

#### 4.8.2 人口減少処理

1. 損耗兵の`originVillageId`を取得
2. 該当知行地の人口を−1
3. **借り兵も同様に人口減少対象**（正式仕様）

```
for each casualty in casualties:
  if casualty.type in [死亡, 廃兵, 逃散]:
    village = getVillage(casualty.originVillageId)
    village.population -= 1
```

#### 4.8.3 負傷兵の扱い

負傷兵は治療後に復帰するため、人口には影響しない。

### 4.9 戦功の計算式（v0.9の4軸＋補正）

#### 4.9.1 軸1：敵士気ダメージ戦功

自隊が関与した押し合いで、減らした敵士気量に応じて加算。

```
小隊：敵士気 / 5
中隊：敵士気 / 10
大隊：敵士気 / 20
```

#### 4.9.2 軸2：崩壊ボーナス

敵中隊の士気を0にした瞬間の押し合いで加点：

- 小隊：+15〜20
- 中隊：+30〜40
- 大隊：+60〜80

#### 4.9.3 軸3：追撃ダメージ戦功

追撃で与えた損耗人数に応じて加点：

- 小隊：人数 ×2
- 中隊：×1.5
- 大隊：×1

#### 4.9.4 軸4：損耗効率（結果評価）

```
損耗効率 = 敵損耗 ÷ 自軍損耗
```

| 比率 | 戦功 |
|------|------|
| 3倍以上 | +10 |
| 2〜3倍 | +5 |
| 1〜2倍 | +2 |
| 1以下 | 0 |

#### 4.9.5 戦局補正（勝敗倍率）

| 結果 | 倍率 |
|------|------|
| 大勝 | ×1.3 |
| 勝ち | ×1.1 |
| 引き分け | ×1.0 |
| 敗北 | ×0.7 |
| 大敗 | ×0.5 |

敗北でも0にはならない。

#### 4.9.6 借りた兵の損耗ペナルティ

- **借りた兵が死・廃兵・逃散**：−1〜−5
- 自村兵はペナルティなし
- 従僕の死亡は評価に影響なし

#### 4.9.7 戦功計算の流れ

```
1. 各家臣の4軸戦功を計算
2. 4軸を合計
3. 戦局補正を適用
4. 借り兵ペナルティを減算
5. 最終戦功を確定
6. 主人公へ集約
```

---

## 第5章：画面仕様（UIモック対応）

### 5.1 軍事編成画面（01_軍事編成画面.html）

#### 入力
- 編成モード選択（自動/手動）
- 階層選択（大隊/中隊/小隊）
- 兵種バランス調整

#### 出力
- 大隊情報（足軽大将名、総兵力、指揮上限）
- 中隊一覧（組頭名、小隊構成、訓練度・士気・疲労バー）
- 兵種構成（徒士・馬上衆・従僕の人数と比率）

#### 表示される状態バー
- 訓練度バー（色分け: 高/中/低）
- 士気バー（色分け: 高/中/低）
- 疲労バー（色分け: 低/中/高）

#### UIイベントとロジックの接続
- 自動編成実行 → 自動編成ロジック呼び出し
- 中隊カードクリック → 中隊詳細画面へ遷移
- 小隊ブロッククリック → 小隊詳細画面へ遷移

### 5.2 隊状態パネル（02_隊状態パネル.html）

#### 入力
- 階層選択（大隊/中隊/小隊）

#### 出力
- 大隊一覧（訓練度・実戦度・疲労・士気のバーと補正値）
- 状態推移グラフ（簡易版）

#### 表示される状態バー
- 訓練度バー + 補正値表示
- 実戦度バー + 補正値表示
- 疲労バー + 状態バッジ（✓/⚠）
- 士気バー + 状態バッジ（✓/⚠）

#### UIイベントとロジックの接続
- 詳細ボタン → 隊詳細画面へ遷移
- 訓練ボタン → 訓練ロジック呼び出し
- 休息ボタン → 休息ロジック呼び出し

### 5.3 戦場UI（03_戦場UI.html）

#### 入力
- 一時停止/終了ボタン

#### 出力
- ミニマップ（敵軍・自軍の配置）
- 押し合い状況（自軍戦力・敵軍戦力、戦力比バー、判定結果）
- 中隊ローテーション（前線/後衛の中隊配置）
- 結果ログ（押し合い・ローテ・崩壊・追撃のログ）

#### 表示される状態バー
- 自軍戦力バー（青）
- 敵軍戦力バー（赤）

#### UIイベントとロジックの接続
- 押し合いサイクル → 有効戦闘力算出・勝敗判定
- ローテ発生 → 中隊AI判断
- 崩壊発生 → 追撃判定開始

### 5.4 兵士損耗レポート（04_兵士損耗レポート.html）

#### 入力
- タブ選択（死亡/廃兵/負傷/逃散）

#### 出力
- 損耗サマリー（死亡・廃兵・負傷・逃散の人数と比率、人口減少合計）
- 死亡者一覧（名前・兵種・出身知行地・自/借・小隊）
- 知行地別人口減少（知行地ごとの死亡・廃兵・逃散・合計・人口減少）

#### 表示専用項目
- 人口減少合計（死亡 + 廃兵 + 逃散）
- 負傷兵の「影響なし」バッジ

#### UIイベントとロジックの接続
- 人口データ確認ボタン → 知行地データ画面へ遷移
- 戦功レポートへボタン → 家臣戦功レポート画面へ遷移

### 5.5 家臣戦功レポート（05_家臣戦功レポート.html）

#### 入力
- ソート・フィルター

#### 出力
- 戦功サマリー（4軸合計、戦局補正、借兵ペナルティ、確定戦功）
- 家臣別戦功一覧（名前・役職・士気ダメージ・崩壊・追撃・効率・補正・合計）
- 4軸戦功の詳細（小隊・中隊・大隊の計算式）
- 個人戦功 → 主人公集約

#### 表示専用項目
- 4軸戦功の計算式
- 戦局補正の倍率
- 主人公への集約結果

#### UIイベントとロジックの接続
- 戦功を確定ボタン → 戦功確定処理
- 主人公ステータスへボタン → 主人公画面へ遷移

### 5.6 非表示の内部パラメータ

以下のパラメータは内部ロジックのみで使用し、UIには表示しない：

- **地形適性**（追撃条件・追撃強度の判定に使用）
- 揺らぎの詳細計算値
- 個別兵士の戦闘力値

---

## 第6章：イベント仕様

### 6.1 戦闘開始

#### トリガー
- プレイヤーが戦闘開始を選択

#### 処理
1. 大隊・中隊・小隊の状態を初期化
2. 兵士データを読み込み
3. 戦場UIを表示
4. 押し合いサイクルを開始

### 6.2 押し合いサイクル

#### トリガー
- 戦闘開始後、一定時間ごと

#### 処理
1. 有効戦闘力を算出
2. 勝敗を判定
3. 士気・疲労を更新
4. 押し合い中の損耗を処理
5. 崩壊判定を実行
6. 結果ログに記録

### 6.3 小隊撤退

#### トリガー
- 小隊の士気20以下または疲労90以上

#### 処理
1. 小隊を前線から後衛に移動
2. 中隊に報告
3. 中隊は予備小隊を前線に投入
4. 結果ログに記録

### 6.4 中隊ローテ

#### トリガー
- 前線小隊の疲労が基準値（70/80/90）に達する

#### 処理
1. 中隊AIがローテを判断
2. 前線小隊と後衛小隊を交代
3. 交代した小隊は休息開始
4. 戦場UIに表示
5. 結果ログに記録

### 6.5 段階後退

#### トリガー
- 大隊平均士気30未満、または前線中隊2つが士気20未満

#### 処理
1. 大隊AIが段階後退を判断
2. 前線中隊を後退
3. 後衛中隊を前線に投入
4. 戦場UIに表示
5. 結果ログに記録

### 6.6 総退却

#### トリガー
- 大隊平均士気20未満、または前線2つが士気20未満、または総兵力30%未満

#### 処理
1. 大隊AIが総退却を判断
2. 全中隊を戦場から離脱
3. 戦闘終了処理を開始
4. 戦場UIに表示
5. 結果ログに記録

### 6.7 崩壊

#### トリガー
- 中隊の士気が0になる

#### 処理
1. 中隊を崩壊状態に設定
2. 中隊を戦場から離脱
3. 敵大隊AIが追撃判定を開始
4. 戦場UIに表示
5. 結果ログに記録

### 6.8 追撃

#### トリガー
- 敵中隊が崩壊、かつ追撃条件を満たす

#### 処理
1. 追撃条件を判定
2. 追撃強度（P1/P2/P3）を決定
3. 追撃側の損耗を処理（死亡0〜0.5%、負傷2〜5%）
4. 敵側の損耗を処理（死亡・廃兵・負傷・逃散）
5. 戦場UIに表示
6. 結果ログに記録

### 6.9 リザルト生成

#### トリガー
- 戦闘終了

#### 処理
1. 損耗データを集計
2. 知行地別人口減少を計算
3. 人口を更新
4. 戦功を計算（4軸＋戦局補正＋借兵ペナルティ）
5. 主人公へ戦功を集約
6. 兵士損耗レポートを生成
7. 家臣戦功レポートを生成
8. 戦闘結果サマリーを表示

---

## 第7章：例外／制約

### 7.1 v0.9で未実装のもの

以下の要素はv1.0以降で対応：

- 総大将の戦略AI
- 地形効果の細分化
- 伏兵・包囲・陣形
- 個人視点戦場UI
- 戦後の略奪・治安・街道への影響
- 精鋭部隊／包囲戦モデル
- 長期的な疲労・補充イベント

### 7.2 UIに出さないもの

以下のパラメータは内部ロジックのみで使用し、UIには表示しない：

- **地形適性**（追撃条件・追撃強度の判定に使用）
- 揺らぎの詳細計算値
- 個別兵士の戦闘力値

### 7.3 将来拡張の独立性確保

v0.9のロジックは、以下の将来拡張に対して独立性を確保する：

- 総大将AIの追加（大隊AIの上位層として追加可能）
- 陣形システムの追加（有効戦闘力算出に陣形補正を追加）
- 地形効果の細分化（地形適性パラメータの拡張）
- 精鋭部隊モデルの追加（訓練度・実戦度の上限拡張）

---

## 第8章：仕様書完成宣言

本仕様書は、v0.9要件定義書、v0.9設計書、v0.9 UIモック、および別紙A〜Mに基づき作成された。

以下の6点の正確化事項を反映済み：

1. **総退却条件の士気値**: 士気20未満（設計書の「士気10未満」を修正）
2. **馬上衆死亡時の士気低下**: 士気−2〜5（徒士より重い）
3. **追撃側損耗の数値明示**: 死亡0〜0.5%、負傷2〜5%
4. **借り兵の人口減少**: 借り兵も人口減少対象
5. **地形適性の扱い**: 内部ロジックのみ、UI表示なし
6. **中隊／小隊の状態同期**: UIモックの状態バーとロジックを明確に結合

本仕様書に基づき、v0.9の実装を行うこと。

---

以上で v0.9 仕様書を完成します
