# 仕様書 v0.8（婚姻・縁談・世代交代）

## 1. 概要
本設計書は、v0.8 要件定義書および関連別紙（A〜M）に基づき、以下の機能を実装するための仕様を定義する。

*   **婚姻システム**: 他家からの縁談オファー、自家からの縁談持ちかけ、家格差による評価変動。
*   **子供・元服**: 子供の誕生、成長、成人、元服時の初期役職付与。
*   **世代交代**: 当主死亡時の家督継承、パラメータ継承、家臣団の反応（忠誠変化）。

本仕様は「家としての歴史」を構築し、戦国時代らしい世代交代と人間関係を実現することを目的とする。

---

## 2. データ構造

### 2.1. 家データ (HouseData)拡張
既存の家データに対し、以下の項目を追加・拡張する。

| 項目名 | 型 | 説明 | 参照別紙 |
| :--- | :--- | :--- | :--- |
| `Kakaku` | `int` | 家格（社会的信用）。0〜100等の数値またはランク。 | B |
| `KakakuExp` | `int` | 家格経験値。婚姻等で増減し、一定値で家格昇降。 | B |
| `Debts` | `Dictionary<HouseId, int>` | 貸し借り値。他家に対する恩義・貸し。 | J |
| `MerchantCredit` | `int` | 商人信用度。 | H |
| `TempleCredit` | `int` | 寺社信用度。 | H |
| `Connections` | `List<PersonId>` | 人脈リスト。 | - |
| `MarriageStatus` | `Enum` | 未婚 / 既婚（正室あり） / 側室あり 等の状態。 | K |
| `MarriageCandidates` | `List<MarriageOffer>` | 現在届いている縁談オファーのリスト。 | - |
| `GenerationCount` | `int` | 現在の世代数（初代=1）。 | - |

### 2.2. 人物データ (PersonData)拡張
既存の武将・人物データに対し、以下の項目を追加・拡張する。

| 項目名 | 型 | 説明 | 参照別紙 |
| :--- | :--- | :--- | :--- |
| `Affinity` | `int` | 親密度（対主人公家）。0〜100。 | - |
| `Rank` | `Enum` | 役職（従僕〜侍大将）。 | C, I |
| `PersonalRole` | `Enum` | 本人役割（A〜F階層）。家中での実務経験。 | C, E |
| `MaritalStatus` | `Enum` | 未婚 / 既婚。 | K |
| `SpouseId` | `PersonId` | 配偶者ID。 | - |
| `IsAdult` | `bool` | 成人フラグ（15歳以上）。 | - |
| `IsGenpuku` | `bool` | 元服済みフラグ。 | - |
| `IsHeir` | `bool` | 継承対象（後継者）フラグ。 | - |
| `FatherId` | `PersonId` | 父親ID。 | - |
| `MotherId` | `PersonId` | 母親ID。 | - |

### 2.3. 婚姻データ (MarriageOffer)
縁談の申し込み・オファー情報を管理する構造体。

| 項目名 | 型 | 説明 |
| :--- | :--- | :--- |
| `SourceHouseId` | `HouseId` | 申し出元の家ID。 |
| `TargetPersonId` | `PersonId` | 結婚対象の人物ID。 |
| `IsLegalWife` | `bool` | 正室としての縁談か（falseなら側室）。 |
| `Dowry` | `int` | 持参金（提示条件）。 |
| `ConnectionOffer` | `List<PersonId>` | 人脈紹介（提示条件）。 |
| `SuccessProb` | `float` | 成立確率（自家から持ちかける場合）。 |

### 2.4. 継承データ (SuccessionContext)
世代交代処理中に一時的に使用するデータ。

| 項目名 | 型 | 説明 |
| :--- | :--- | :--- |
| `HeirId` | `PersonId` | 後継者ID。 |
| `InheritanceRates` | `Dictionary<string, float>` | 各パラメータの継承率。 |
| `LoyaltyPenalty` | `int` | 全家臣への忠誠低下値。 |

---

## 3. 主要ロジック仕様

### 3.1. 婚姻オファー判定（他家→自家）
*   **発火タイミング**: 月次処理（ただし、発生頻度は3ヶ月に1回まで）。
*   **発生条件**:
    1.  **親密度**: 一定閾値以上であること。
    2.  **家格＋役職**: プレイヤー家の（家格 ＋ 役職ランク値）が高いほど発生確率上昇。
*   **オファー元選定**:
    *   プレイヤー家と「同格」〜「やや格下」の家が中心。
*   **生成データ**: `MarriageOffer` オブジェクトを作成し、`HouseData.MarriageCandidates` に追加。

### 3.2. 自家からの縁談成功率計算
*   **実行条件**: 相手家と「面識」があること。
*   **基本難易度**: 「相手から話が来る場合」より高く設定。
*   **成功率計算式（方向性）**:
    *   `BaseScore` = (家格スコア * 0.6) + (役職スコア * 0.3) + (その他 * 0.1)
    *   `Modifier` = 持参金補正 + 人脈提示補正
    *   `FinalScore` = `BaseScore` + `Modifier`
*   **制約**: 不可能級のマイナス補正は禁止。最低でも「交渉の余地がある」状態を保証する。

### 3.3. 家格経験値処理
婚姻成立時に家格経験値を増減させる。

*   **格上・同格婚**:
    *   経験値 **増加**。
    *   家格差が大きいほど増加量が大きい。
*   **格下婚（正室）**:
    *   同格〜1差下: 影響なし。
    *   2差下: 経験値 **減少**（小）。家中の不満（忠誠低下小）。
    *   3差下以上: 経験値 **大きく減少**。家中の強い不満。
*   **格下婚（側室）**:
    *   2差下まで: 影響なし。
    *   3差下以上: 経験値 **ごく僅かに減少**。

### 3.4. 子供誕生ロジック
*   **判定タイミング**: 月次または年次。
*   **確率**:
    *   結婚後1年以内: 高確率。
    *   以降: 数年周期で判定。
*   **能力生成**:
    *   `ChildStats` = (FatherStats + MotherStats) / 2 ± Random + 家格ボーナス
    *   ※ 方向性のみ。詳細な計算式は実装時に調整。

### 3.5. 元服処理（初期役職付与）
子供が15歳に達した際（元服）、以下のルールで初期役職を決定する。

1.  **基準値**: 親の軍事的地位（役職ランク） - 2段階。
    *   例: 親が部将(4) → 基準は徒士(2)。
2.  **本人役割**: 子供が元服前に担っていた `PersonalRole` に対応する役職ランク。
3.  **決定**: `Max(基準値, 本人役割)` を採用。
4.  **範囲制限**:
    *   下限: 従僕 (Rank 1)
    *   上限: 組頭 (Rank 3)

### 3.6. 家督継承処理（初期役職付与）
当主死亡時、後継者に役職を付与する。

1.  **基準値**: 親（前当主）の最終役職 - 2段階（最低保証）。
2.  **本人役割**: 後継者本人が親家中で担っていた `PersonalRole` に対応する役職。
3.  **決定**: `Max(基準値, 本人役割)` を採用。
4.  **絶対制約**:
    *   **親の最終役職を超えてはならない。**
    *   上限: 組頭 (Rank 3) ※v0.8時点の仕様に従うなら元服同様だが、親が部将なら部将-2=徒士が保証される。ただし別紙C-7に「元服時と同様、上限は組頭」とあるため、これを遵守。

### 3.7. 家中忠誠変化（世代交代時）
継承発生時、全家臣の忠誠値を減算する。

*   **後継者が成人済み (IsAdult == true)**: 全家臣 **-10**
*   **後継者が未成人 (IsAdult == false)**: 全家臣 **-20**

---

## 4. イベント・時系列フロー

### 4.1. 月次処理
1.  **年齢加算**: 全人物の年齢を更新（誕生月判定）。
2.  **成人・元服判定**: 15歳に達した子供に対し、元服イベント（役職付与）を実行。
3.  **子供誕生判定**: 既婚者に対し、確率で子供生成。
4.  **婚姻候補生成**: 条件を満たす場合、他家からの縁談オファーを生成（3ヶ月に1回制限）。
5.  **親密度処理**: 簡易的な変動処理（自然減衰や交流による増加）。

### 4.2. 年次処理
1.  **家格経験値総合処理**: 年間の行動に基づく家格経験値の集計・反映。
2.  **継承準備判定**: 当主が高齢の場合などのフラグ管理（内部処理）。

### 4.3. 死亡・世代交代処理
1.  **当主死亡判定**: 寿命やイベントによる死亡判定。
2.  **死亡確定時**:
    *   後継者選定（`IsHeir`フラグ、長子優先など）。
    *   **パラメータ継承**:
        *   家格: 100%
        *   貸し借り: 60%
        *   商人・寺社信用: 90%
        *   人脈: 100%
    *   **役職付与**: 3.6 のロジックを実行。
    *   **忠誠変動**: 3.7 のロジックを実行。
    *   **UI出力**: 世代交代イベントUIを表示するためのデータを構築。

---

## 5. UIロジック（データ連携）
※ UIの見た目は Windsurf 担当。ここでは渡すべきデータを定義する。

### 5.1. 婚姻候補一覧生成
*   **入力**: `HouseData.MarriageCandidates`
*   **出力**: 表示用リスト（相手家名、対象者名、家格、役職、正室/側室区分、持参金有無）。

### 5.2. 婚姻交渉画面データ
*   **入力**: 対象の他家ID、対象人物ID。
*   **処理**: 成功率試算（3.2ロジック）。
*   **出力**:
    *   現在の成功率（％）。
    *   提示可能な条件リスト（持参金額候補、紹介可能な人脈リスト）。
    *   条件選択ごとの成功率変動予測値。

### 5.3. 元服通知データ
*   **トリガー**: 月次処理での元服発生。
*   **出力**:
    *   対象者名。
    *   付与された初期役職名。
    *   決定要因（「親の威光(基準値)」or「本人の実務(役割)」）。

### 5.4. 継承イベントデータ
*   **トリガー**: 当主死亡時。
*   **出力**:
    *   前当主名、新当主名。
    *   継承された各パラメータ値（家格、信用など）。
    *   新当主の初期役職。
    *   **家中忠誠変化一覧**: 全家臣の「名前」「変動前忠誠」「変動値(-10/-20)」「変動後忠誠」。

---

## 6. 制約条件
1.  **要件定義書のロジック遵守**: 3.1〜3.7 のロジックは要件定義書および別紙の記述を正とし、改変しない。
2.  **家格と出世の分離**: 家格が高くても、それだけで役職が上がることはない（別紙B/I）。
3.  **出世と継承の分離**: 継承時の役職付与は「出世」ロジックとは別系統で処理する（別紙I）。
4.  **本人役割の独立性**: 本人役割（PersonalRole）は役職（Rank）とは別のパラメータとして管理する（別紙C/E）。
5.  **UI仕様の非干渉**: 画面レイアウトやボタン配置については記述しない。
