# 戦国立身出世SLG v0.6 設計書（Antigravity 用）

## 1. データ構造（v0.6追加分）

### 1.1 統率（補正後）データモデル
統率値は階層的に補正され、最終的に小隊（徒士）の行動に影響を与える。

*   **Class: LeadershipHierarchy**
    *   `BushoLeadership`: int (部将の統率値。幕僚補正適用済み)
    *   `KumigashiraLeadership`: int (組頭の統率値。部将からの補正適用済み)
    *   `SquadLeadership`: int (小隊の最終統率値。組頭からの補正適用済み)

### 1.2 小隊ステート管理
各小隊は以下の状態を持つ。

*   **Enum: SquadState**
    *   `Forward` (前進): 敵に向かって進行中
    *   `Hold` (維持): 現在位置を死守
    *   `Retreat` (後退): 安全圏へ撤退中
    *   `Support` (側面支援): 味方小隊を支援
    *   `Disengage` (離脱): 戦闘不能または命令による離脱
    *   `Confused` (混乱): 統率失敗により制御不能

*   **Class: SquadStatus**
    *   `CurrentState`: SquadState
    *   `IsConfused`: bool (混乱フラグ)
    *   `CasualtyRate`: double (累積死亡率 0.0 - 1.0)
    *   `ComplianceScore`: double (現在の命令遵守率)

### 1.3 統率に影響される係数
統率値（0-100）から算出される各種係数。

*   **Struct: LeadershipCoefficients**
    *   `DeathRateFactor`: double (死亡率係数。統率が高いほど低い)
        *   計算式例: `BaseDeathRate * (1.0 - (SquadLeadership * 0.005))`
    *   `ObedienceRate`: double (命令遵守率。統率が高いほど高い)
        *   計算式例: `SquadLeadership / 100.0`
    *   `ConfusionRate`: double (混乱発生率。統率が高いほど低い)
        *   計算式例: `Max(0, 0.2 - (SquadLeadership * 0.002))`

---

## 2. 戦場処理フロー（深度1）

戦闘は以下のシーケンスで処理される。乱戦や地形効果は計算しない。

1.  **初期化フェーズ**
    *   参加部隊（部将・組頭・徒士）の確定
    *   統率階層補正の計算（3. 参照）
    *   各小隊の初期ステート設定（`Hold`）

2.  **ターン処理ループ（戦闘終了まで）**
    1.  **命令発行**: プレイヤー（部将）が全体方針（前進/維持/後退）を決定
    2.  **統率判定**: 各小隊ごとに命令遵守判定（4. 参照）
    3.  **行動決定**: 判定結果に基づき、小隊の次ターン `SquadState` を決定
    4.  **損害計算**: 現在の `SquadState` と敵戦力に基づき死亡・混乱判定（6. 参照）
    5.  **ログ出力**: 小隊ごとの行動と結果をテキストログに追加
    6.  **終了判定**: 規定ターン経過 or 全滅 or 撤退完了で終了

3.  **結果集計フェーズ**
    *   総死者数の確定
    *   生存者への功績付与
    *   帰還処理

---

## 3. 統率階層補正モデル（仕様の核心）

上層の統率力が下層へ伝播し、最終的な小隊の能力を決定する。**このロジックは出世条件（昇格判定）には一切使用しない。**

### 3.1 補正順序と計算式

1.  **部将（Commander）**
    *   `BaseLeadership`: 本人の素の統率値
    *   `StaffBonus`: 幕僚（補佐官）がいる場合、その知略・政務による補正（+50% max）
    *   `EffectiveCommanderLeadership` = `BaseLeadership` * (1 + `StaffBonus`)

2.  **組頭（Captain）**
    *   `BaseLeadership`: 本人の素の統率値
    *   `CommanderDiff`: `EffectiveCommanderLeadership` - `BaseLeadership`
    *   `Correction`: `CommanderDiff` > 0 ? `CommanderDiff` * 0.5 : 0 （上司が優秀な場合のみ補正）
    *   `EffectiveCaptainLeadership` = `BaseLeadership` + `Correction`

3.  **徒士小隊（Squad）**
    *   **小隊の統率値として `EffectiveCaptainLeadership` をそのまま使用する**
    *   徒士個人の統率値は存在しない（小隊として扱われるため）

### 3.2 適用範囲
*   この補正モデルは「戦場での小隊の挙動」のみに適用される。
*   組頭自身の昇格判定には、補正前の `BaseLeadership` もしくは功績値のみが使用される。

---

## 4. 小隊AI（深度1）

### 4.1 行動候補
小隊は以下のいずれかの行動をとる。
*   **前進 (Advance)**: 敵戦力へ接近。死亡率高。
*   **維持 (Hold)**: 現在地で防御。死亡率中。
*   **後退 (Retreat)**: 戦闘回避。死亡率低。
*   **側面支援 (Support)**: 他小隊の死亡率を下げる。
*   **離脱 (Disengage)**: 戦場から消える。

### 4.2 命令遵守判定
プレイヤーの方針（GlobalOrder）に対し、各小隊が従うかを判定する。

*   **判定ロジック**:
    *   乱数 `R` (0.0 - 1.0) を生成
    *   `R` < `ObedienceRate` (命令遵守率) の場合: **命令通りに行動**
    *   `R` >= `ObedienceRate` の場合: **命令ズレ発生**

### 4.3 命令ズレの発生条件と挙動
命令に従わなかった場合、以下の優先順位で勝手に行動する。

1.  **混乱中 (`IsConfused` == true)**: ランダムに `Retreat` または `Hold`
2.  **統率不足**:
    *   GlobalOrderが `Advance` (危険) -> `Hold` または `Retreat` (怯え)
    *   GlobalOrderが `Retreat` (安全) -> `Hold` または `Advance` (逃げ遅れ/突出)

---

## 5. 従僕護衛AI（軽量）

主人公（プレイヤー）直属の従僕隊の挙動。

### 5.1 追随ロジック
*   **基本原則**: 常に主人公と同じ `SquadState` を選択しようとする。
*   **ターゲット追随**: 主人公が攻撃対象としている敵部隊を優先ターゲットとする。

### 5.2 筆頭従僕の優先行動
*   筆頭従僕（Head Servant）がいる場合、従僕隊の `ObedienceRate` に +10% の補正を与える。
*   独立した戦術判断は行わず、あくまで「主人公を守る/主人公と共に戦う」ことに徹する。

---

## 6. 損害処理

### 6.1 死亡率計算
各ターン、各小隊ごとに以下の要因で死亡数を算出する。

*   `BaseDamage`: 敵戦力と現在の `SquadState` による基本ダメージ
    *   `Advance`: 高
    *   `Hold`: 中
    *   `Retreat`: 低
*   `LeadershipReduction`: `SquadLeadership` による軽減
    *   `FinalDamage` = `BaseDamage` * (1.0 - (`SquadLeadership` / 200.0))
*   `ConfusionPenalty`: 混乱中はダメージ 1.5倍

### 6.2 混乱判定
ダメージを受けた際、統率判定を行う。
*   乱数 `R` < `ConfusionRate` の場合、次ターンから `IsConfused = true` となる。
*   混乱は `Retreat` 行動をとることで確率で回復する。

### 6.3 戦死結果と帰還
*   死亡した兵数は即座に `Vassal` データの兵数から減算される。
*   全滅（兵数0）した場合、その小隊は `Disengage` となり、以降の戦闘に参加しない。
*   戦闘終了後、生存数に応じて功績が計算される。

---

## 7. 既存コードへの差分統合指針

### 7.1 Models (Models.cs)
*   `Vassal` クラスには変更を加えない（統率値は既存のものを使用）。
*   新規クラス `BattleSquad` を定義し、戦闘中の一時データ（補正後統率、State、現在兵数）を保持させる。
*   新規クラス `BattleContext` を定義し、戦場全体のステートを管理する。

### 7.2 GameService (GameService.cs)
*   `ProcessBattleTurn()` メソッドを新規追加。
    *   v0.55 の簡易戦闘ロジックを、このメソッド内の深度1ロジックに置き換える。
*   `CalculateLeadershipHierarchy()` メソッドを追加。
    *   戦闘開始時に一度だけ呼ばれ、階層補正を計算して `BattleSquad` を初期化する。

### 7.3 境界線
*   **深度2・3（v0.7以降）との境界**:
    *   小隊間の連携（Aが攻撃中にBが支援など）は実装しない。
    *   地形データ（山・川）は参照しない。
    *   士気（Morale）パラメータは導入しない（混乱は統率のみで判定）。
*   **出世ロジック**:
    *   `PromotionLogic` には一切触れない。統率変数は戦闘クラス内でのみ完結させる。
