# 戦国立身出世SLG v0.9 設計書

## 第1章：システム概要（v0.9の目的）

### 1.1 バージョン目的

v0.9は戦場システムの基礎構造を確定し、v1.0〜1.1の陣形・AI強化・戦場UIの土台を作ることを目的とする。

### 1.2 完成させる要素

本バージョンで完成させる要素は以下の通り：

- 25・100・300人階層の隊構造
- 押し合い（戦闘処理）の数学モデル
- 状態モデル（訓練度・実戦度・疲労・士気）
- 小隊／中隊／大隊のAI行動ロジック
- 士気崩壊 → 追撃 → 損耗（死・廃兵・負傷・逃散）処理
- 損耗に応じた人口減少ロジック
- 戦功（功績）モデルの基本形
- UI構造モック（HTML/CSS）の作成

### 1.3 スコープ

内部ロジックの実装とUI構造モックの作成を範囲内とする。

- **内部ロジック**: Antigravityが実装
- **UI構造モック**: Windsurfが作成（HTML/CSS、ロジックなし）

---

## 第2章：隊階層構造（25・100・300）

### 2.1 小隊（25人単位）＝小頭

#### 役割
- 戦場の最小戦闘単位
- 個人戦闘力の集積で戦う
- 「押し合い」に直接参加
- 徒士・馬上衆・従僕の個人戦力加算が乗る

#### 構成
- 基本兵力：25人
- 指揮官：小頭
- 個人ユニット（徒士・馬上衆・従僕）の戦力加算を受ける

### 2.2 中隊（100人）＝組頭

#### 役割
- 小隊4つ＋予備を再配置して前線維持
- 小隊の疲労・士気を監視しローテーション
- 大隊命令の実行者

#### 性格による影響
性格（慎重／標準／猪突）は、ローテの基準（疲労70/80/90）にだけ影響する。

#### 構成
- 基本兵力：100人（小隊4つ）
- 指揮官：組頭

### 2.3 大隊（300人）＝足軽大将

#### 役割
- 中隊の前線／後衛を管理
- ローテーション、段階的後退、総退却を決定
- 士気0で崩壊した敵への追撃判断を実施

#### 追撃判定
追撃判定には、指揮官性格は使用しない。

#### 構成
- 基本兵力：300人（中隊3つ）
- 指揮官：足軽大将

### 2.4 個人ユニット（徒士・馬上衆・従僕）

#### 徒士
- 小隊戦力に +（個人戦力値）
- 死亡 → 小隊戦力がその分だけ減少
- 小隊が混乱することはない（士気−2〜4）

#### 馬上衆
- 徒士より高い個人加算
- 死亡時は加算分が消えるだけ
- 小隊は混乱しない（士気−2〜5）

#### 従僕
- 戦力に含まれない
- 死亡しても小隊に影響なし
- 小頭が一時的に精度低下（戦場内でのみ）

---

## 第3章：状態モデル

各隊は以下の状態を持つ。これらが有効戦闘力（Effective Combat Power）を決める。

### 3.1 訓練度（上限値）

戦闘力の最大値を引き上げる。

```
訓練補正 = 0.5 + (訓練度 / 200)
```

### 3.2 実戦度（安定性）

揺らぎ（±15%）の安定度が上昇。

```
実戦補正 = 0.6 + (実戦度 / 200)
```

### 3.3 疲労（疲弊デバフ）

| 疲労 | 戦闘力補正 |
|------|-----------|
| 0〜49 | ペナルティなし |
| 50〜79 | −10% |
| 80〜99 | −20% |
| 100 | −40%（戦闘不能） |

### 3.4 士気（崩壊トリガー）

| 士気 | 状態 |
|------|------|
| 40↑ | 良好 |
| 20〜39 | 軽デバフ |
| 1〜19 | 重デバフ |
| 0 | 即崩壊（離脱） |

### 3.5 隊列維持（隊全体のまとまり）

- 訓練度と中隊指揮の結果で算出
- 押し合いでの有効戦闘力に軽微反映

---

## 第4章：押し合い（戦闘サイクル）

押し合いは「サイクル」として繰り返す。

### 4.1 有効戦闘力の算出

```
有効戦闘力 = 基礎戦力 × 訓練補正 × 実戦補正 × 疲労補正 × 士気補正 × 揺らぎ
```

### 4.2 勝敗判定

戦闘力を比較し、以下のいずれかを判定：
- 勝ち
- 拮抗
- 負け

### 4.3 士気・疲労更新

勝敗結果に応じて、各隊の士気と疲労を更新する。

### 4.4 損耗処理

押し合い中の死者は0.1〜3％。大半は崩壊後の追撃フェーズで発生する。

### 4.5 崩壊判定

士気0 → 崩壊確定 → 中隊離脱

---

## 第5章：小隊AI

### 5.1 戦闘処理

小隊は押し合いに直接参加し、有効戦闘力を算出して戦闘を行う。

### 5.2 自律後退条件

小隊が以下の条件を満たす場合、自律的に後退する：
- 士気20以下
- 疲労90以上

### 5.3 小隊の内部構造

小隊は以下の要素で構成される：
- 基本兵力（25人）
- 徒士の個人戦力加算
- 馬上衆の個人戦力加算
- 従僕（戦力には含まれない）

---

## 第6章：中隊AI

中隊AIは小隊4つの状態を管理する。

### 6.1 ローテの基準（性格差のみ）

性格によってローテーション判断の疲労基準が異なる：
- 慎重：疲労70
- 標準：疲労80
- 猪突：疲労90

### 6.2 自律後退

小隊が以下の条件を満たす場合、自律的に下がる：
- 士気20以下
- 疲労90以上

### 6.3 中隊AIの目的

- 前線維持
- 小隊の損耗を防ぐ
- 足軽大将命令の実行

### 6.4 構成隊の管理と前後交代

中隊は小隊4つを管理し、疲労・士気に応じて前線と後衛を交代させる。

---

## 第7章：大隊AI

大隊AIは戦局そのものを判断する。

### 7.1 戦線管理

大隊は中隊の前線／後衛配置を管理する。

### 7.2 ローテ判定

以下のいずれかでローテーションを実施：
- 前線中隊疲労80以上
- 士気30未満
- 連続押し負け
- 後衛中隊が存在する

### 7.3 段階的後退（退き口）

以下のいずれかで段階的後退を実施：
- 大隊平均士気30未満
- 前線中隊2つが士気20未満
- 中隊控えゼロで、前線状態が限界

### 7.4 総退却（全軍離脱）

以下のいずれかで総退却を実施：
- 大隊平均士気20未満
- 前線2つが士気10未満
- 総兵力30%未満

### 7.5 追撃判定と追撃強度

#### 追撃条件
以下の条件をすべて満たす場合に追撃を実施：
- 自軍疲労 < 60
- 自軍士気 ≥ 50
- 敵が完全崩壊（士気0）
- 地形が追撃可能

#### 追撃強度
以下の要素で追撃強度（P1〜P3の3段階）を決定：
- 自軍疲労
- 自軍士気
- 敵壊乱度
- 地形

指揮官性格は使用しない。

---

## 第8章：損耗処理（死・廃兵・負傷・逃散）

### 8.1 押し合い中の損耗

押し合い中の死者は0.1〜3％。

### 8.2 崩壊後の損耗

大半の損耗は崩壊後の追撃フェーズで発生する。

### 8.3 最大損耗30％

勝敗による最悪ケースでの最大損耗は30％。

```
死亡：〜5%
廃兵：〜5%
負傷（治療後復帰）：10〜15%
逃散：〜5%
```

### 8.4 個人ユニットの死亡時の影響差

#### 徒士
- 小隊戦力減少
- 士気−2〜4

#### 馬上衆
- 小隊戦力減少
- 士気−2〜5

#### 従僕
- 小隊に影響なし
- 小頭の一時的精度低下

---

## 第9章：人口反映ロジック

### 9.1 死亡・廃兵・逃散のみ人口減

人口から減少するのは以下のみ：
- 死亡
- 廃兵
- 逃散

負傷は人口を減らさない。

### 9.2 出身知行地IDに紐づけて人口−1

各兵に「出身知行地ID」を持たせ、該当兵の出身地の人口を−1する。

### 9.3 負傷は人口に影響しない

負傷兵は治療後に復帰するため、人口には影響しない。

---

## 第10章：戦功モデル（4軸＋戦局補正）

戦功は以下の「4軸」で構成し、最後に戦局補正をかける。

### 10.1 軸1：士気ダメージ戦功

自隊が関与した押し合いで、減らした敵士気量に応じて加算。

```
小隊：敵士気 / 5
中隊：敵士気 / 10
大隊：敵士気 / 20
```

### 10.2 軸2：崩壊ボーナス

敵中隊の士気を0にした瞬間の押し合いで加点：
- 小隊：+15〜20
- 中隊：+30〜40
- 大隊：+60〜80

### 10.3 軸3：追撃ダメージ戦功

追撃で与えた損耗人数に応じて加点：
- 小隊：人数 ×2
- 中隊：×1.5
- 大隊：×1

### 10.4 軸4：損耗効率（結果評価）

```
損耗効率 = 敵損耗 ÷ 自軍損耗
```

| 比率 | 戦功 |
|------|------|
| 3倍以上 | +10 |
| 2〜3倍 | +5 |
| 1〜2倍 | +2 |
| 1以下 | 0 |

### 10.5 戦局補正（勝敗倍率）

| 結果 | 倍率 |
|------|------|
| 大勝 | ×1.3 |
| 勝ち | ×1.1 |
| 引き分け | ×1.0 |
| 敗北 | ×0.7 |
| 大敗 | ×0.5 |

敗北でも0にはならない。

### 10.6 借りた兵の損耗ペナルティ

- 借りた兵が死・廃兵・逃散：−1〜−5
- 自村兵はペナルティなし
- 従僕の死亡は評価に影響なし

---

## 第11章：仕様上の制約

### 11.1 実装禁止範囲

本バージョンでは以下を実装しない：
- UIロジック（イベントハンドラ、データバインディング）
- 画面遷移の実装
- バックエンドとの連携

注：UI構造モック（静的HTML/CSS）はWindsurfが作成する。

### 11.2 v0.9外の要素

以下の要素はv1.0以降で対応：
- 総大将の戦略AI
- 地形効果の細分化
- 伏兵・包囲・陣形
- 個人視点戦場UI
- 戦後の略奪・治安・街道への影響
- 精鋭部隊／包囲戦モデル
- 長期的な疲労・補充イベント

### 11.3 別紙との関連性

本設計書は要件定義書に記載された内容のみを反映し、A〜M別紙は要件定義書内に引用済みのため、別紙を直接参照しない。

---

## 第12章：1.0以降で扱う拡張事項

### 12.1 総大将AI

総大将の戦略的判断AIは1.0以降で実装。

### 12.2 陣形・包囲

陣形システムおよび包囲戦モデルは1.0以降で実装。

### 12.3 戦場UI

個人視点の戦場UIは1.0以降で実装。

### 12.4 街道・治安ペナルティ

戦後の略奪・治安・街道への影響は1.0以降で実装。

### 12.5 長期疲労・精鋭特色

長期的な疲労管理および精鋭部隊の特色は1.0以降で実装。

---

以上で v0.9 設計書を完成します
